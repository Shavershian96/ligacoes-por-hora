name: Build EXE with Icon and MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller matplotlib requests

      - name: Gerar EXE com PyInstaller
        run: |
          pyinstaller --noconsole --onefile ligacoes.py --icon=icone.ico --name LigacoesPorHora

      - name: Baixar Inno Setup
        run: |
          Invoke-WebRequest -Uri https://jrsoftware.org/download.php/is.exe -OutFile is.exe
          Start-Process .\is.exe /VERYSILENT /NORESTART /DIR="C:\InnoSetup" -Wait

      - name: Criar script do Inno Setup
        run: |
          echo '''
          [Setup]
          AppName=LigacoesPorHora
          AppVersion=1.0
          DefaultDirName={pf}\\LigacoesPorHora
          OutputDir=dist
          OutputBaseFilename=LigacoesPorHoraInstaller
          Compression=lzma
          SolidCompression=yes
          SetupIconFile=icone.ico

          [Files]
          Source: "dist\\LigacoesPorHora.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\\LigacoesPorHora"; Filename: "{app}\\LigacoesPorHora.exe"
          ''' > installer.iss

      - name: Gerar Instalador MSI
        run: |
          "C:\\InnoSetup\\ISCC.exe" installer.iss

      - name: Upload do .EXE
        uses: actions/upload-artifact@v4
        with:
          name: ligacoes-exe
          path: dist/LigacoesPorHora.exe

      - name: Upload do Instalador
        uses: actions/upload-artifact@v4
        with:
          name: ligacoes-installer
          path: dist/LigacoesPorHoraInstaller.exe

